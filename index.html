<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chapa">
    <meta name="description" content="Clima, mareas, surf y condiciones de playa en Chapadmalal">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <title>Chapa üåä</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-alt: #0f3460;
            --accent: #e94560;
            --accent-soft: #ff6b6b;
            --teal: #4ecdc4;
            --sand: #f7d794;
            --text: #eaeaea;
            --text-muted: #a0a0a0;
            --glass: rgba(255,255,255,0.08);
            --good: #00b894;
            --ok: #fdcb6e;
            --bad: #e94560;
            --surf-blue: #0984e3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text);
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            padding: 20px 16px 10px;
            text-align: center;
            position: sticky;
            top: 0;
            background: var(--bg-dark);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .header h1 span {
            color: var(--teal);
        }

        .header .location {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .last-update {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin: 10px 16px;
            background: var(--glass);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .tab.active {
            background: var(--teal);
            color: var(--bg-dark);
        }

        .tab:not(.active) {
            color: var(--text-muted);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Content */
        .content {
            padding: 16px;
        }

        /* Alerta destacada */
        .alert-banner {
            background: linear-gradient(135deg, var(--accent) 0%, #c0392b 100%);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .alert-banner.surf-good {
            background: linear-gradient(135deg, var(--surf-blue) 0%, #0652DD 100%);
        }

        .alert-banner .alert-icon {
            font-size: 1.5rem;
        }

        .alert-banner .alert-text {
            flex: 1;
        }

        .alert-banner .alert-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .alert-banner .alert-desc {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Main score card */
        .main-score {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-alt) 100%);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .main-score.surf {
            background: linear-gradient(135deg, #0f3460 0%, #0a1628 100%);
        }

        .main-score.surf::before {
            background: radial-gradient(circle, var(--surf-blue) 0%, transparent 70%);
        }

        .main-score::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--teal) 0%, transparent 70%);
            opacity: 0.1;
        }

        .main-score .date {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .main-score .score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .main-score .emoji {
            font-size: 3.5rem;
        }

        .main-score .score-number {
            font-size: 4rem;
            font-weight: 700;
            color: var(--teal);
            line-height: 1;
        }

        .main-score.surf .score-number {
            color: var(--surf-blue);
        }

        .main-score .score-max {
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .main-score .score-label {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .main-score .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .main-score .stat {
            background: var(--glass);
            padding: 10px 6px;
            border-radius: 10px;
        }

        .main-score .stat-icon {
            font-size: 1.2rem;
            display: block;
        }

        .main-score .stat-value {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .main-score .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Cards expandibles */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .card-header:active {
            background: var(--glass);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .icon {
            font-size: 1.3rem;
        }

        .card-title .text {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-title .subtext {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .card-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-value {
            text-align: right;
        }

        .card-value .main {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card-value .main.good { color: var(--good); }
        .card-value .main.ok { color: var(--ok); }
        .card-value .main.bad { color: var(--bad); }
        .card-value .main.surf { color: var(--surf-blue); }

        .card-value .sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .card-toggle {
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .card.expanded .card-toggle {
            transform: rotate(180deg);
        }

        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .card.expanded .card-content {
            max-height: 1000px;
        }

        .card-inner {
            padding: 0 16px 16px;
        }

        /* Info box dentro de cards */
        .info-box {
            background: var(--glass);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 3px solid var(--teal);
        }

        .info-box.surf {
            border-left-color: var(--surf-blue);
        }

        /* Hourly scroll */
        .hourly-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .hourly-scroll::-webkit-scrollbar {
            display: none;
        }

        .hour-item {
            flex-shrink: 0;
            background: var(--glass);
            border-radius: 12px;
            padding: 10px 12px;
            text-align: center;
            min-width: 65px;
        }

        .hour-item.current {
            background: var(--teal);
            color: var(--bg-dark);
        }

        .hour-item.current.surf {
            background: var(--surf-blue);
        }

        .hour-item .time {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .hour-item .value {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 4px 0;
        }

        .hour-item .extra {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Tide timeline */
        .tide-timeline {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tide-event {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--glass);
            border-radius: 10px;
        }

        .tide-event.high {
            border-left: 3px solid var(--teal);
        }

        .tide-event.low {
            border-left: 3px solid var(--sand);
        }

        .tide-event.past {
            opacity: 0.5;
        }

        .tide-event .tide-icon {
            font-size: 1.3rem;
        }

        .tide-event .tide-info {
            flex: 1;
        }

        .tide-event .tide-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .tide-event .tide-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .tide-event .tide-time {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .tide-event .tide-height {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Forecast days */
        .forecast-days {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .day-card {
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
        }

        .day-header {
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .day-header:active {
            background: rgba(255,255,255,0.05);
        }

        .day-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-emoji {
            font-size: 1.8rem;
        }

        .day-name {
            font-weight: 600;
        }

        .day-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .day-right {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .day-score {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .day-score.good { color: var(--good); }
        .day-score.ok { color: var(--ok); }
        .day-score.bad { color: var(--bad); }
        .day-score.surf { color: var(--surf-blue); }

        .day-summary {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .day-toggle {
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .day-card.expanded .day-toggle {
            transform: rotate(180deg);
        }

        .day-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .day-card.expanded .day-content {
            max-height: 600px;
        }

        .day-inner {
            padding: 0 14px 14px;
        }

        .day-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--glass);
            font-size: 0.85rem;
        }

        .day-detail-row:last-child {
            border-bottom: none;
        }

        .day-detail-label {
            color: var(--text-muted);
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-card {
            background: var(--accent);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        /* Refresh button */
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--teal);
            color: var(--bg-dark);
            border: none;
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(78, 205, 196, 0.4);
            z-index: 100;
        }

        .refresh-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
        }

        /* API Key prompt */
        .api-prompt {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .api-prompt h3 {
            margin-bottom: 12px;
            color: var(--sand);
        }

        .api-prompt p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .api-prompt input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--glass);
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .api-prompt button {
            width: 100%;
            padding: 12px;
            background: var(--teal);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Section headers */
        .section-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 12px;
            padding-left: 4px;
        }

        /* Surf specific */
        .wave-visual {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            height: 60px;
            margin: 10px 0;
        }

        .wave-bar {
            width: 8px;
            background: var(--surf-blue);
            border-radius: 4px 4px 0 0;
            opacity: 0.6;
        }

        .wave-bar.active {
            opacity: 1;
            background: linear-gradient(to top, var(--surf-blue), var(--teal));
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåä <span>CHAPA</span></h1>
        <p class="location">Chapadmalal, Buenos Aires</p>
        <p class="last-update" id="lastUpdate"></p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('playa')">‚òÄÔ∏è Playa</div>
        <div class="tab" onclick="switchTab('surf')">üèÑ Surf</div>
    </div>

    <div class="content" id="content">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando condiciones...</p>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadAllData()" id="refreshBtn">
        üîÑ Actualizar
    </button>

    <script>
        // =====================================================
        // CONFIGURACI√ìN
        // =====================================================
        const CONFIG = {
            lat: -38.176,
            lon: -57.645,
            timezone: 'America/Argentina/Buenos_Aires',
            beachHourStart: 9,
            beachHourEnd: 19,
            // Surf config para Chapadmalal
            // Mejor swell: Sur a Sudeste (135-225¬∞)
            // Offshore: Noroeste (270-360¬∞ o 0-45¬∞)
            idealSwellDirMin: 135,
            idealSwellDirMax: 225,
            offshoreWindMin: 270,
            offshoreWindMax: 45
        };

        let WORLDTIDES_KEY = localStorage.getItem('worldtides_key') || '';
        let currentTab = 'playa';
        let weatherData = null;
        let marineData = null;
        let tidesData = null;

        // =====================================================
        // UTILIDADES
        // =====================================================

        function formatTime(date) {
            return date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric' });
        }

        function getWindDirection(degrees) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        function isSouthWind(dir) {
            return dir >= 135 && dir <= 225;
        }

        function isSudestada(windSpeed, windDir) {
            const isSudeste = windDir >= 112 && windDir <= 157;
            return isSudeste && windSpeed >= 35;
        }

        function isOffshoreWind(dir) {
            // Para Chapadmalal, offshore es viento del NO (270-360 o 0-45)
            return (dir >= 270 && dir <= 360) || (dir >= 0 && dir <= 45);
        }

        function isGoodSwellDirection(dir) {
            // Mejor swell: S a SE (135-225¬∞)
            return dir >= CONFIG.idealSwellDirMin && dir <= CONFIG.idealSwellDirMax;
        }

        // =====================================================
        // DESCRIPCIONES HUMANAS - PLAYA
        // =====================================================

        function getWindDescription(speed, dir) {
            const isSouth = isSouthWind(dir);

            if (isSouth) {
                if (speed <= 10) return { text: 'Brisa del sur', emoji: 'üå¨Ô∏è', class: 'ok' };
                if (speed <= 20) return { text: 'Viento sur fr√≠o', emoji: 'ü•∂', class: 'bad' };
                if (speed <= 30) return { text: 'Sur fuerte', emoji: 'üí®', class: 'bad' };
                return { text: 'Temporal del sur', emoji: 'üåä', class: 'bad' };
            } else {
                if (speed <= 10) return { text: 'Calma', emoji: 'üòå', class: 'good' };
                if (speed <= 20) return { text: 'Brisa suave', emoji: 'üçÉ', class: 'good' };
                if (speed <= 30) return { text: 'Ventoso', emoji: 'üí®', class: 'ok' };
                return { text: 'Muy ventoso', emoji: 'üå™Ô∏è', class: 'bad' };
            }
        }

        function getTempDescription(temp, apparent) {
            const diff = apparent - temp;
            let base = '';
            let emoji = '';

            if (temp >= 30) { base = 'Muy caluroso'; emoji = 'ü•µ'; }
            else if (temp >= 26) { base = 'Calor ideal'; emoji = '‚òÄÔ∏è'; }
            else if (temp >= 22) { base = 'Agradable'; emoji = 'üòä'; }
            else if (temp >= 18) { base = 'Templado'; emoji = 'üå§Ô∏è'; }
            else if (temp >= 14) { base = 'Fresco'; emoji = 'üß•'; }
            else { base = 'Fr√≠o'; emoji = 'ü•∂'; }

            if (diff <= -3) base += ' (ST m√°s fr√≠o)';
            else if (diff >= 3) base += ' (ST m√°s calor)';

            return { text: base, emoji };
        }

        function getCloudDescription(cover) {
            if (cover <= 10) return { text: 'Despejado', emoji: '‚òÄÔ∏è' };
            if (cover <= 30) return { text: 'Poco nublado', emoji: 'üå§Ô∏è' };
            if (cover <= 60) return { text: 'Parcialmente nublado', emoji: '‚õÖ' };
            if (cover <= 85) return { text: 'Nublado', emoji: '‚òÅÔ∏è' };
            return { text: 'Muy nublado', emoji: 'üå´Ô∏è' };
        }

        function getRainDescription(prob, precip) {
            if (prob === 0 && precip === 0) return { text: 'Sin lluvia', emoji: '‚ú®', class: 'good' };
            if (prob <= 20) return { text: 'Muy improbable', emoji: 'üå§Ô∏è', class: 'good' };
            if (prob <= 40) return { text: 'Poco probable', emoji: 'üå•Ô∏è', class: 'ok' };
            if (prob <= 60) return { text: 'Posible', emoji: 'üå¶Ô∏è', class: 'ok' };
            if (prob <= 80) return { text: 'Probable', emoji: 'üåßÔ∏è', class: 'bad' };
            return { text: 'Muy probable', emoji: '‚õàÔ∏è', class: 'bad' };
        }

        function getUVDescription(uv) {
            if (uv <= 2) return { text: 'Bajo', emoji: 'üü¢', tip: 'Sin protecci√≥n' };
            if (uv <= 5) return { text: 'Moderado', emoji: 'üü°', tip: 'Protector recomendado' };
            if (uv <= 7) return { text: 'Alto', emoji: 'üü†', tip: 'Protector necesario' };
            if (uv <= 10) return { text: 'Muy alto', emoji: 'üî¥', tip: 'Evitar sol 11-16hs' };
            return { text: 'Extremo', emoji: 'üü£', tip: 'No exponerse' };
        }

        // =====================================================
        // DESCRIPCIONES HUMANAS - SURF
        // =====================================================

        function getWaveHeightDescription(height) {
            if (height < 0.3) return { text: 'Flat', emoji: 'üò¥', class: 'bad' };
            if (height < 0.6) return { text: 'Chico', emoji: 'üåä', class: 'ok' };
            if (height < 1.0) return { text: 'Bueno', emoji: 'üèÑ', class: 'good' };
            if (height < 1.5) return { text: 'Grande', emoji: 'üî•', class: 'good' };
            if (height < 2.5) return { text: 'Muy grande', emoji: '‚ö†Ô∏è', class: 'ok' };
            return { text: 'Peligroso', emoji: 'üö´', class: 'bad' };
        }

        function getWavePeriodDescription(period) {
            if (period < 6) return { text: 'Muy corto', desc: 'Olas d√©biles, sin fuerza', class: 'bad' };
            if (period < 8) return { text: 'Corto', desc: 'Olas con poca energ√≠a', class: 'ok' };
            if (period < 10) return { text: 'Bueno', desc: 'Olas con buena energ√≠a', class: 'good' };
            if (period < 14) return { text: 'Muy bueno', desc: 'Olas potentes y limpias', class: 'good' };
            return { text: 'Excelente', desc: 'Swell de fondo, m√°xima potencia', class: 'good' };
        }

        function getSwellDirectionDescription(dir) {
            const isGood = isGoodSwellDirection(dir);
            const dirName = getWindDirection(dir);

            if (isGood) {
                return { text: `${dirName} ‚úì`, desc: 'Direcci√≥n ideal para Chapa', class: 'good' };
            } else if (dir >= 90 && dir <= 270) {
                return { text: dirName, desc: 'Direcci√≥n aceptable', class: 'ok' };
            } else {
                return { text: dirName, desc: 'Swell no llega bien', class: 'bad' };
            }
        }

        function getWindForSurfDescription(speed, dir) {
            const offshore = isOffshoreWind(dir);
            const dirName = getWindDirection(dir);

            if (speed <= 5) {
                return { text: 'Glassy ü™û', desc: 'Sin viento, condiciones perfectas', class: 'good' };
            } else if (offshore && speed <= 20) {
                return { text: `Offshore ${dirName} üå¨Ô∏è`, desc: 'Viento ideal, alisa las olas', class: 'good' };
            } else if (offshore && speed <= 30) {
                return { text: `Offshore fuerte ${dirName}`, desc: 'Bueno pero intenso', class: 'ok' };
            } else if (!offshore && speed <= 15) {
                return { text: `Onshore leve ${dirName}`, desc: 'Olas algo desarmadas', class: 'ok' };
            } else {
                return { text: `Onshore ${dirName} üí®`, desc: 'Olas chopy y desordenadas', class: 'bad' };
            }
        }

        // =====================================================
        // √çNDICE DE PLAYA
        // =====================================================

        function calculateBeachIndex(dayData) {
            const beachHours = dayData.hours.filter(h =>
                h.hour >= CONFIG.beachHourStart && h.hour <= CONFIG.beachHourEnd
            );

            if (beachHours.length === 0) return 1;

            let totalScore = 0;
            let count = beachHours.length;

            beachHours.forEach(h => {
                let hourScore = 10;

                if (h.temp < 18) hourScore -= 3;
                else if (h.temp < 22) hourScore -= 2;
                else if (h.temp < 24) hourScore -= 1;
                else if (h.temp > 34) hourScore -= 2;
                else if (h.temp > 30) hourScore -= 1;

                if (h.apparent < h.temp - 4) hourScore -= 1;

                const windPenalty = isSouthWind(h.windDir) ? 1.5 : 1;
                if (h.wind > 40) hourScore -= 4 * windPenalty;
                else if (h.wind > 30) hourScore -= 3 * windPenalty;
                else if (h.wind > 20) hourScore -= 2 * windPenalty;
                else if (h.wind > 15) hourScore -= 1 * windPenalty;

                if (h.gusts > 50) hourScore -= 2;
                else if (h.gusts > 40) hourScore -= 1;

                if (h.rainProb > 70) hourScore -= 3;
                else if (h.rainProb > 50) hourScore -= 2;
                else if (h.rainProb > 30) hourScore -= 1;

                if (h.clouds > 85) hourScore -= 2;
                else if (h.clouds > 60) hourScore -= 1;

                totalScore += Math.max(0, hourScore);
            });

            const avg = totalScore / count;
            return Math.max(1, Math.min(10, Math.round(avg)));
        }

        function getBeachIndexInfo(score) {
            if (score >= 8) return { emoji: 'üèñÔ∏è', label: 'Excelente', class: 'good' };
            if (score >= 6) return { emoji: 'üòé', label: 'Bueno', class: 'good' };
            if (score >= 4) return { emoji: 'üå•Ô∏è', label: 'Regular', class: 'ok' };
            if (score >= 2) return { emoji: 'üòï', label: 'Malo', class: 'bad' };
            return { emoji: '‚ùå', label: 'No ir', class: 'bad' };
        }

        // =====================================================
        // √çNDICE DE SURF
        // =====================================================

        function calculateSurfIndex(waveHeight, wavePeriod, swellDir, windSpeed, windDir) {
            let score = 0;

            // Altura de olas (m√°x 3 puntos)
            if (waveHeight >= 0.8 && waveHeight <= 2.0) score += 3;
            else if (waveHeight >= 0.5 && waveHeight <= 2.5) score += 2;
            else if (waveHeight >= 0.3) score += 1;

            // Per√≠odo (m√°x 3 puntos) - MUY importante
            if (wavePeriod >= 10) score += 3;
            else if (wavePeriod >= 8) score += 2;
            else if (wavePeriod >= 6) score += 1;

            // Direcci√≥n del swell (m√°x 2 puntos)
            if (isGoodSwellDirection(swellDir)) score += 2;
            else if (swellDir >= 90 && swellDir <= 270) score += 1;

            // Viento (m√°x 2 puntos)
            if (windSpeed <= 5) score += 2; // Glassy
            else if (isOffshoreWind(windDir) && windSpeed <= 25) score += 2;
            else if (isOffshoreWind(windDir)) score += 1;
            else if (windSpeed <= 15) score += 1;

            return Math.max(1, Math.min(10, score));
        }

        function getSurfIndexInfo(score) {
            if (score >= 8) return { emoji: 'üî•', label: '√âpico', class: 'good' };
            if (score >= 6) return { emoji: 'üèÑ', label: 'Bueno', class: 'good' };
            if (score >= 4) return { emoji: 'üåä', label: 'Regular', class: 'ok' };
            if (score >= 2) return { emoji: 'üòê', label: 'Malo', class: 'bad' };
            return { emoji: 'üò¥', label: 'Flat', class: 'bad' };
        }

        // =====================================================
        // FETCH DE DATOS
        // =====================================================

        async function fetchWeather() {
            const params = [
                'temperature_2m',
                'apparent_temperature',
                'precipitation_probability',
                'precipitation',
                'cloud_cover',
                'wind_speed_10m',
                'wind_direction_10m',
                'wind_gusts_10m',
                'uv_index',
                'visibility'
            ].join(',');

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.lat}&longitude=${CONFIG.lon}&hourly=${params}&daily=sunrise,sunset&timezone=${CONFIG.timezone}&forecast_days=7`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Error al obtener clima');
            return response.json();
        }

        async function fetchMarine() {
            const params = [
                'wave_height',
                'wave_direction',
                'wave_period',
                'swell_wave_height',
                'swell_wave_direction',
                'swell_wave_period'
            ].join(',');

            const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${CONFIG.lat}&longitude=${CONFIG.lon}&hourly=${params}&timezone=${CONFIG.timezone}&forecast_days=7`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Error al obtener datos marinos');
            return response.json();
        }

        async function fetchTides() {
            if (!WORLDTIDES_KEY) {
                console.log('Sin API key de WorldTides, usando estimaci√≥n');
                return null;
            }

            try {
                const url = `https://www.worldtides.info/api/v3?extremes&lat=${CONFIG.lat}&lon=${CONFIG.lon}&days=7&key=${WORLDTIDES_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error WorldTides');
                const data = await response.json();

                if (data.error) {
                    console.warn('WorldTides error:', data.error);
                    return null;
                }

                return data;
            } catch (e) {
                console.warn('Error fetching tides:', e);
                return null;
            }
        }

        // =====================================================
        // ESTIMACI√ìN DE MAREAS (fallback)
        // =====================================================

        function estimateTides(startDate, numDays) {
            const tides = [];
            const msPerHour = 3600000;
            const tidalPeriod = 12.42 * msPerHour;

            const J2000 = Date.UTC(2000, 0, 1, 12, 0, 0);
            const daysSinceJ2000 = (startDate.getTime() - J2000) / 86400000;
            const moonPhase = (daysSinceJ2000 * 13.176396) % 360;
            const offsetHours = (moonPhase / 360) * 12.42;

            let currentTime = new Date(startDate);
            currentTime.setHours(0, 0, 0, 0);
            currentTime = new Date(currentTime.getTime() + offsetHours * msPerHour);

            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + numDays);

            let isHigh = true;

            while (currentTime < endDate) {
                tides.push({
                    time: new Date(currentTime),
                    type: isHigh ? 'high' : 'low',
                    height: isHigh ? 1.2 + Math.random() * 0.3 : 0.3 + Math.random() * 0.2,
                    estimated: true
                });

                currentTime = new Date(currentTime.getTime() + tidalPeriod / 2);
                isHigh = !isHigh;
            }

            return tides;
        }

        // =====================================================
        // PROCESAMIENTO DE DATOS
        // =====================================================

        function processWeatherByDay(data) {
            const days = {};
            const now = new Date();

            data.hourly.time.forEach((time, i) => {
                const date = new Date(time);
                const dayKey = date.toDateString();

                if (!days[dayKey]) {
                    days[dayKey] = {
                        date: date,
                        hours: [],
                        maxTemp: -Infinity,
                        minTemp: Infinity,
                        maxWind: 0,
                        maxGusts: 0,
                        maxRainProb: 0,
                        avgClouds: 0,
                        maxUV: 0,
                        hasSouthWind: false,
                        hasSudestada: false
                    };
                }

                const hourData = {
                    hour: date.getHours(),
                    time: date,
                    temp: data.hourly.temperature_2m[i],
                    apparent: data.hourly.apparent_temperature[i],
                    rainProb: data.hourly.precipitation_probability[i],
                    rain: data.hourly.precipitation[i],
                    clouds: data.hourly.cloud_cover[i],
                    wind: data.hourly.wind_speed_10m[i],
                    windDir: data.hourly.wind_direction_10m[i],
                    gusts: data.hourly.wind_gusts_10m[i],
                    uv: data.hourly.uv_index[i],
                    visibility: data.hourly.visibility[i],
                    isCurrent: date.getHours() === now.getHours() && date.toDateString() === now.toDateString()
                };

                days[dayKey].hours.push(hourData);

                if (hourData.hour >= 8 && hourData.hour <= 20) {
                    days[dayKey].maxTemp = Math.max(days[dayKey].maxTemp, hourData.temp);
                    days[dayKey].minTemp = Math.min(days[dayKey].minTemp, hourData.temp);
                    days[dayKey].maxWind = Math.max(days[dayKey].maxWind, hourData.wind);
                    days[dayKey].maxGusts = Math.max(days[dayKey].maxGusts, hourData.gusts);
                    days[dayKey].maxRainProb = Math.max(days[dayKey].maxRainProb, hourData.rainProb);
                    days[dayKey].maxUV = Math.max(days[dayKey].maxUV, hourData.uv);

                    if (isSouthWind(hourData.windDir)) days[dayKey].hasSouthWind = true;
                    if (isSudestada(hourData.wind, hourData.windDir)) days[dayKey].hasSudestada = true;
                }
            });

            Object.values(days).forEach(day => {
                const beachHours = day.hours.filter(h => h.hour >= 8 && h.hour <= 20);
                day.avgClouds = beachHours.reduce((sum, h) => sum + h.clouds, 0) / beachHours.length;
                day.beachIndex = calculateBeachIndex(day);
            });

            return Object.values(days);
        }

        function processMarineByDay(data) {
            if (!data || !data.hourly) return [];

            const days = {};
            const now = new Date();

            data.hourly.time.forEach((time, i) => {
                const date = new Date(time);
                const dayKey = date.toDateString();

                if (!days[dayKey]) {
                    days[dayKey] = {
                        date: date,
                        hours: [],
                        maxWaveHeight: 0,
                        avgWavePeriod: 0,
                        dominantSwellDir: 0
                    };
                }

                const hourData = {
                    hour: date.getHours(),
                    time: date,
                    waveHeight: data.hourly.wave_height?.[i] || 0,
                    waveDir: data.hourly.wave_direction?.[i] || 0,
                    wavePeriod: data.hourly.wave_period?.[i] || 0,
                    swellHeight: data.hourly.swell_wave_height?.[i] || 0,
                    swellDir: data.hourly.swell_wave_direction?.[i] || 0,
                    swellPeriod: data.hourly.swell_wave_period?.[i] || 0,
                    isCurrent: date.getHours() === now.getHours() && date.toDateString() === now.toDateString()
                };

                days[dayKey].hours.push(hourData);
                days[dayKey].maxWaveHeight = Math.max(days[dayKey].maxWaveHeight, hourData.waveHeight);
            });

            // Calcular promedios y surf index
            Object.values(days).forEach(day => {
                const surfHours = day.hours.filter(h => h.hour >= 6 && h.hour <= 19);
                if (surfHours.length > 0) {
                    day.avgWavePeriod = surfHours.reduce((sum, h) => sum + h.wavePeriod, 0) / surfHours.length;
                    day.dominantSwellDir = surfHours[Math.floor(surfHours.length / 2)].swellDir || surfHours[0].waveDir;
                }
            });

            return Object.values(days);
        }

        function processTides(tidesData, estimatedTides) {
            if (tidesData && tidesData.extremes) {
                return tidesData.extremes.map(t => ({
                    time: new Date(t.date),
                    type: t.type === 'High' ? 'high' : 'low',
                    height: t.height,
                    estimated: false
                }));
            }
            return estimatedTides;
        }

        function getTidesForDay(allTides, dayDate) {
            const dayStart = new Date(dayDate);
            dayStart.setHours(0, 0, 0, 0);
            const dayEnd = new Date(dayDate);
            dayEnd.setHours(23, 59, 59, 999);

            return allTides.filter(t => t.time >= dayStart && t.time <= dayEnd);
        }

        // =====================================================
        // UI - TABS Y TOGGLE
        // =====================================================

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:${tab === 'playa' ? 'first-child' : 'last-child'}`).classList.add('active');
            render();
        }

        function toggleCard(element) {
            const card = element.closest('.card') || element.closest('.day-card');
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // =====================================================
        // RENDER - PLAYA
        // =====================================================

        function renderPlaya(days, allTides, tidesAreEstimated) {
            const today = days[0];
            const now = new Date();
            const currentHour = now.getHours();
            const currentWeather = today.hours.find(h => h.hour === currentHour) || today.hours[0];
            const indexInfo = getBeachIndexInfo(today.beachIndex);

            const todayTides = getTidesForDay(allTides, now);
            const nextTide = allTides.find(t => t.time > now);

            // Alertas
            const alerts = [];
            if (today.hasSudestada) {
                alerts.push({ type: 'danger', icon: 'üåä', title: 'Alerta Sudestada', desc: 'Condiciones peligrosas en la costa' });
            } else if (today.hasSouthWind && today.maxWind > 25) {
                alerts.push({ type: 'warning', icon: 'üí®', title: 'Viento Sur fuerte', desc: 'Playa inc√≥moda, mucho viento y fr√≠o' });
            }
            if (today.maxRainProb > 60) {
                alerts.push({ type: 'warning', icon: 'üåßÔ∏è', title: 'Probabilidad de lluvia', desc: `Hasta ${today.maxRainProb}% durante el d√≠a` });
            }

            let html = '';

            // Alertas
            alerts.forEach(alert => {
                html += `
                    <div class="alert-banner ${alert.type === 'warning' ? 'warning' : ''}">
                        <span class="alert-icon">${alert.icon}</span>
                        <div class="alert-text">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-desc">${alert.desc}</div>
                        </div>
                    </div>
                `;
            });

            // API key prompt
            if (!WORLDTIDES_KEY) {
                html += `
                    <div class="api-prompt">
                        <h3>üåä Mareas precisas</h3>
                        <p>Para mareas exactas, ingres√° tu API key de WorldTides ($10 = 5,000 consultas).</p>
                        <input type="text" id="apiKeyInput" placeholder="Tu API key de WorldTides">
                        <button onclick="saveApiKey()">Guardar</button>
                    </div>
                `;
            }

            // Score principal
            const windDesc = getWindDescription(currentWeather.wind, currentWeather.windDir);
            const tempDesc = getTempDescription(currentWeather.temp, currentWeather.apparent);
            const cloudDesc = getCloudDescription(currentWeather.clouds);
            const rainDesc = getRainDescription(currentWeather.rainProb, currentWeather.rain);

            html += `
                <div class="main-score">
                    <p class="date">${formatDate(today.date)}</p>
                    <div class="score-row">
                        <span class="emoji">${indexInfo.emoji}</span>
                        <div>
                            <span class="score-number">${today.beachIndex}</span><span class="score-max">/10</span>
                        </div>
                    </div>
                    <p class="score-label">${indexInfo.label} para playa</p>

                    <div class="quick-stats">
                        <div class="stat">
                            <span class="stat-icon">${tempDesc.emoji}</span>
                            <span class="stat-value">${Math.round(currentWeather.temp)}¬∞</span>
                            <span class="stat-label">Ahora</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">${windDesc.emoji}</span>
                            <span class="stat-value">${Math.round(currentWeather.wind)}</span>
                            <span class="stat-label">km/h</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">${cloudDesc.emoji}</span>
                            <span class="stat-value">${currentWeather.clouds}%</span>
                            <span class="stat-label">Nubes</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">${rainDesc.emoji}</span>
                            <span class="stat-value">${currentWeather.rainProb}%</span>
                            <span class="stat-label">Lluvia</span>
                        </div>
                    </div>
                </div>
            `;

            // Cards de temperatura, viento, lluvia, UV
            html += renderWeatherCards(today, currentWeather, tempDesc, windDesc, cloudDesc, rainDesc);

            // Card de Mareas
            html += renderTidesCard(todayTides, nextTide, tidesAreEstimated, now);

            // Pr√≥ximos d√≠as
            html += `<div class="section-header">Pr√≥ximos d√≠as</div>`;
            html += `<div class="forecast-days">`;

            days.slice(1, 6).forEach(day => {
                const dayInfo = getBeachIndexInfo(day.beachIndex);
                const dayTides = getTidesForDay(allTides, day.date);

                html += renderDayCard(day, dayInfo, dayTides, 'playa');
            });

            html += `</div>`;

            return html;
        }

        // =====================================================
        // RENDER - SURF
        // =====================================================

        function renderSurf(weatherDays, marineDays, allTides) {
            if (!marineDays || marineDays.length === 0) {
                return '<div class="error-card">No se pudieron cargar los datos de olas</div>';
            }

            const today = marineDays[0];
            const weatherToday = weatherDays[0];
            const now = new Date();
            const currentHour = now.getHours();
            const currentMarine = today.hours.find(h => h.hour === currentHour) || today.hours[0];
            const currentWeather = weatherToday.hours.find(h => h.hour === currentHour) || weatherToday.hours[0];

            const surfIndex = calculateSurfIndex(
                currentMarine.waveHeight,
                currentMarine.wavePeriod,
                currentMarine.swellDir || currentMarine.waveDir,
                currentWeather.wind,
                currentWeather.windDir
            );
            const indexInfo = getSurfIndexInfo(surfIndex);

            const waveDesc = getWaveHeightDescription(currentMarine.waveHeight);
            const periodDesc = getWavePeriodDescription(currentMarine.wavePeriod);
            const swellDesc = getSwellDirectionDescription(currentMarine.swellDir || currentMarine.waveDir);
            const windSurfDesc = getWindForSurfDescription(currentWeather.wind, currentWeather.windDir);

            let html = '';

            // Alerta de buenas condiciones
            if (surfIndex >= 7) {
                html += `
                    <div class="alert-banner surf-good">
                        <span class="alert-icon">üî•</span>
                        <div class="alert-text">
                            <div class="alert-title">Buenas condiciones!</div>
                            <div class="alert-desc">Las olas est√°n para salir</div>
                        </div>
                    </div>
                `;
            }

            // Score principal
            html += `
                <div class="main-score surf">
                    <p class="date">${formatDate(today.date)}</p>
                    <div class="score-row">
                        <span class="emoji">${indexInfo.emoji}</span>
                        <div>
                            <span class="score-number">${surfIndex}</span><span class="score-max">/10</span>
                        </div>
                    </div>
                    <p class="score-label">${indexInfo.label} para surf</p>

                    <div class="quick-stats">
                        <div class="stat">
                            <span class="stat-icon">üåä</span>
                            <span class="stat-value">${currentMarine.waveHeight.toFixed(1)}m</span>
                            <span class="stat-label">Altura</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">‚è±Ô∏è</span>
                            <span class="stat-value">${Math.round(currentMarine.wavePeriod)}s</span>
                            <span class="stat-label">Per√≠odo</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">üß≠</span>
                            <span class="stat-value">${getWindDirection(currentMarine.swellDir || currentMarine.waveDir)}</span>
                            <span class="stat-label">Swell</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">${windSurfDesc.class === 'good' ? '‚úì' : '‚úó'}</span>
                            <span class="stat-value">${Math.round(currentWeather.wind)}</span>
                            <span class="stat-label">Viento</span>
                        </div>
                    </div>
                </div>
            `;

            // Card: Altura de olas
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üåä</span>
                            <div>
                                <div class="text">Altura de olas</div>
                                <div class="subtext">${waveDesc.text}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${waveDesc.class}">${currentMarine.waveHeight.toFixed(1)}m</div>
                                <div class="sub">M√°x: ${today.maxWaveHeight.toFixed(1)}m</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 6 && h.hour <= 20).map(h => {
                                    const hd = getWaveHeightDescription(h.waveHeight);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current surf' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${h.waveHeight.toFixed(1)}</div>
                                            <div class="extra">${hd.emoji}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Card: Per√≠odo
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">‚è±Ô∏è</span>
                            <div>
                                <div class="text">Per√≠odo de olas</div>
                                <div class="subtext">${periodDesc.desc}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${periodDesc.class}">${Math.round(currentMarine.wavePeriod)}s</div>
                                <div class="sub">${periodDesc.text}</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="info-box surf">
                                <strong>¬øPor qu√© importa el per√≠odo?</strong><br>
                                A mayor per√≠odo (8s+), las olas tienen m√°s energ√≠a y potencia. Per√≠odos cortos (&lt;6s) generan olas d√©biles y sin fuerza.
                            </div>
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 6 && h.hour <= 20).map(h => {
                                    const pd = getWavePeriodDescription(h.wavePeriod);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current surf' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${Math.round(h.wavePeriod)}s</div>
                                            <div class="extra">${pd.class === 'good' ? '‚úì' : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Card: Direcci√≥n del swell
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üß≠</span>
                            <div>
                                <div class="text">Direcci√≥n del swell</div>
                                <div class="subtext">${swellDesc.desc}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${swellDesc.class}">${swellDesc.text}</div>
                                <div class="sub">Ideal: S-SE</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="info-box surf">
                                <strong>Mejor direcci√≥n para Chapadmalal:</strong><br>
                                Swell del Sur a Sudeste (S-SE) entra de frente y genera las mejores olas. Swells del Norte no llegan bien.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Card: Viento
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üí®</span>
                            <div>
                                <div class="text">Viento</div>
                                <div class="subtext">${windSurfDesc.desc}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${windSurfDesc.class}">${windSurfDesc.text.split(' ')[0]}</div>
                                <div class="sub">${Math.round(currentWeather.wind)} km/h ${getWindDirection(currentWeather.windDir)}</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="info-box surf">
                                <strong>Offshore vs Onshore:</strong><br>
                                ‚Ä¢ <strong>Offshore (NO para Chapa):</strong> Viento desde tierra, alisa las olas ‚úì<br>
                                ‚Ä¢ <strong>Onshore:</strong> Viento desde el mar, desarma las olas ‚úó<br>
                                ‚Ä¢ <strong>Glassy:</strong> Sin viento, condiciones perfectas ‚úì
                            </div>
                            <div class="hourly-scroll">
                                ${weatherToday.hours.filter(h => h.hour >= 6 && h.hour <= 20).map(h => {
                                    const wd = getWindForSurfDescription(h.wind, h.windDir);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current surf' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${Math.round(h.wind)}</div>
                                            <div class="extra">${getWindDirection(h.windDir)} ${wd.class === 'good' ? '‚úì' : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Pr√≥ximos d√≠as SURF
            html += `<div class="section-header">Pr√≥ximos d√≠as</div>`;
            html += `<div class="forecast-days">`;

            marineDays.slice(1, 6).forEach((day, i) => {
                const weatherDay = weatherDays[i + 1];
                if (!weatherDay) return;

                const avgWind = weatherDay.hours.filter(h => h.hour >= 6 && h.hour <= 18)
                    .reduce((sum, h) => sum + h.wind, 0) / 12;
                const avgWindDir = weatherDay.hours.filter(h => h.hour >= 6 && h.hour <= 18)
                    .reduce((sum, h) => sum + h.windDir, 0) / 12;

                const daySurfIndex = calculateSurfIndex(
                    day.maxWaveHeight,
                    day.avgWavePeriod,
                    day.dominantSwellDir,
                    avgWind,
                    avgWindDir
                );
                const dayInfo = getSurfIndexInfo(daySurfIndex);
                const dayTides = getTidesForDay(allTides, day.date);

                html += `
                    <div class="day-card">
                        <div class="day-header" onclick="toggleCard(this)">
                            <div class="day-left">
                                <span class="day-emoji">${dayInfo.emoji}</span>
                                <div>
                                    <div class="day-name">${formatDateShort(day.date)}</div>
                                    <div class="day-date">${dayInfo.label}</div>
                                </div>
                            </div>
                            <div class="day-right">
                                <div>
                                    <span class="day-score surf">${daySurfIndex}</span>
                                    <div class="day-summary">
                                        üåä${day.maxWaveHeight.toFixed(1)}m ¬∑ ‚è±Ô∏è${Math.round(day.avgWavePeriod)}s
                                    </div>
                                </div>
                                <span class="day-toggle">‚ñº</span>
                            </div>
                        </div>
                        <div class="day-content">
                            <div class="day-inner">
                                <div class="day-detail-row">
                                    <span class="day-detail-label">üåä Altura m√°x</span>
                                    <span>${day.maxWaveHeight.toFixed(1)}m</span>
                                </div>
                                <div class="day-detail-row">
                                    <span class="day-detail-label">‚è±Ô∏è Per√≠odo prom</span>
                                    <span>${Math.round(day.avgWavePeriod)}s</span>
                                </div>
                                <div class="day-detail-row">
                                    <span class="day-detail-label">üß≠ Swell</span>
                                    <span>${getWindDirection(day.dominantSwellDir)}</span>
                                </div>
                                <div class="day-detail-row">
                                    <span class="day-detail-label">üí® Viento prom</span>
                                    <span>${Math.round(avgWind)} km/h ${getWindDirection(avgWindDir)}</span>
                                </div>
                                ${dayTides.length > 0 ? dayTides.map(t => `
                                    <div class="day-detail-row">
                                        <span class="day-detail-label">${t.type === 'high' ? 'üî∫ Pleamar' : 'üîª Bajamar'}</span>
                                        <span>${formatTime(t.time)}</span>
                                    </div>
                                `).join('') : ''}

                                <div style="margin-top: 12px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">Olas por hora:</div>
                                    <div class="hourly-scroll">
                                        ${day.hours.filter(h => h.hour >= 6 && h.hour <= 19).map(h => `
                                            <div class="hour-item">
                                                <div class="time">${h.hour}h</div>
                                                <div class="value">${h.waveHeight.toFixed(1)}</div>
                                                <div class="extra">${Math.round(h.wavePeriod)}s</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            return html;
        }

        // =====================================================
        // RENDER HELPERS
        // =====================================================

        function renderWeatherCards(today, currentWeather, tempDesc, windDesc, cloudDesc, rainDesc) {
            let html = '';

            // Temperatura
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üå°Ô∏è</span>
                            <div>
                                <div class="text">Temperatura</div>
                                <div class="subtext">${tempDesc.text}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main">${Math.round(today.minTemp)}¬∞ - ${Math.round(today.maxTemp)}¬∞</div>
                                <div class="sub">ST: ${Math.round(currentWeather.apparent)}¬∞</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 8 && h.hour <= 22).map(h => `
                                    <div class="hour-item ${h.isCurrent ? 'current' : ''}">
                                        <div class="time">${h.hour}:00</div>
                                        <div class="value">${Math.round(h.temp)}¬∞</div>
                                        <div class="extra">ST ${Math.round(h.apparent)}¬∞</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Viento
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üí®</span>
                            <div>
                                <div class="text">Viento</div>
                                <div class="subtext">${windDesc.text}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${windDesc.class}">${Math.round(currentWeather.wind)} km/h</div>
                                <div class="sub">${getWindDirection(currentWeather.windDir)} ¬∑ R√°f ${Math.round(currentWeather.gusts)}</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 8 && h.hour <= 22).map(h => {
                                    const wd = getWindDescription(h.wind, h.windDir);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${Math.round(h.wind)}</div>
                                            <div class="extra">${getWindDirection(h.windDir)} ${wd.emoji}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Lluvia y nubes
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üåßÔ∏è</span>
                            <div>
                                <div class="text">Lluvia y nubes</div>
                                <div class="subtext">${rainDesc.text} ¬∑ ${cloudDesc.text}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main ${rainDesc.class}">${today.maxRainProb}%</div>
                                <div class="sub">m√°x prob.</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 8 && h.hour <= 22).map(h => {
                                    const cd = getCloudDescription(h.clouds);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${cd.emoji}</div>
                                            <div class="extra">${h.rainProb}% üåßÔ∏è</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // UV
            const uvDesc = getUVDescription(currentWeather.uv);
            html += `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">‚òÄÔ∏è</span>
                            <div>
                                <div class="text">√çndice UV</div>
                                <div class="subtext">${uvDesc.tip}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main">${uvDesc.emoji} ${uvDesc.text}</div>
                                <div class="sub">M√°x: ${Math.round(today.maxUV)}</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="hourly-scroll">
                                ${today.hours.filter(h => h.hour >= 8 && h.hour <= 20).map(h => {
                                    const ud = getUVDescription(h.uv);
                                    return `
                                        <div class="hour-item ${h.isCurrent ? 'current' : ''}">
                                            <div class="time">${h.hour}:00</div>
                                            <div class="value">${ud.emoji}</div>
                                            <div class="extra">UV ${Math.round(h.uv)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function renderTidesCard(todayTides, nextTide, tidesAreEstimated, now) {
            return `
                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="card-title">
                            <span class="icon">üåä</span>
                            <div>
                                <div class="text">Mareas ${tidesAreEstimated ? '(estimadas)' : ''}</div>
                                <div class="subtext">${nextTide ? (nextTide.type === 'high' ? 'Sube ‚Üí Pleamar' : 'Baja ‚Üí Bajamar') : ''}</div>
                            </div>
                        </div>
                        <div class="card-right">
                            <div class="card-value">
                                <div class="main">${nextTide ? formatTime(nextTide.time) : '--'}</div>
                                <div class="sub">${nextTide ? (nextTide.type === 'high' ? 'pr√≥x. alta' : 'pr√≥x. baja') : ''}</div>
                            </div>
                            <span class="card-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-inner">
                            <div class="tide-timeline">
                                ${todayTides.map(t => {
                                    const isPast = t.time < now;
                                    const isHigh = t.type === 'high';
                                    return `
                                        <div class="tide-event ${t.type} ${isPast ? 'past' : ''}">
                                            <span class="tide-icon">${isHigh ? 'üî∫' : 'üîª'}</span>
                                            <div class="tide-info">
                                                <div class="tide-type">${isHigh ? 'Pleamar (alta)' : 'Bajamar (baja)'}</div>
                                                <div class="tide-desc">${isHigh ? 'Menos playa, mar m√°s cerca' : 'M√°s playa, mar m√°s lejos'}</div>
                                            </div>
                                            <div>
                                                <div class="tide-time">${formatTime(t.time)}</div>
                                                ${t.height ? `<div class="tide-height">${t.height.toFixed(1)}m</div>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${tidesAreEstimated ? '<p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px; text-align: center;">‚ö†Ô∏è Mareas aproximadas. Agreg√° tu API key de WorldTides para datos precisos.</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDayCard(day, dayInfo, dayTides, mode) {
            return `
                <div class="day-card">
                    <div class="day-header" onclick="toggleCard(this)">
                        <div class="day-left">
                            <span class="day-emoji">${dayInfo.emoji}</span>
                            <div>
                                <div class="day-name">${formatDateShort(day.date)}</div>
                                <div class="day-date">${dayInfo.label}</div>
                            </div>
                        </div>
                        <div class="day-right">
                            <div>
                                <span class="day-score ${dayInfo.class}">${day.beachIndex}</span>
                                <div class="day-summary">
                                    ${Math.round(day.minTemp)}¬∞-${Math.round(day.maxTemp)}¬∞ ¬∑ üí®${Math.round(day.maxWind)}
                                </div>
                            </div>
                            <span class="day-toggle">‚ñº</span>
                        </div>
                    </div>
                    <div class="day-content">
                        <div class="day-inner">
                            <div class="day-detail-row">
                                <span class="day-detail-label">üå°Ô∏è Temperatura</span>
                                <span>${Math.round(day.minTemp)}¬∞ - ${Math.round(day.maxTemp)}¬∞</span>
                            </div>
                            <div class="day-detail-row">
                                <span class="day-detail-label">üí® Viento m√°x</span>
                                <span>${Math.round(day.maxWind)} km/h ${day.hasSouthWind ? '(Sur ‚ö†Ô∏è)' : ''}</span>
                            </div>
                            <div class="day-detail-row">
                                <span class="day-detail-label">üåßÔ∏è Prob. lluvia</span>
                                <span>${day.maxRainProb}%</span>
                            </div>
                            <div class="day-detail-row">
                                <span class="day-detail-label">‚òÅÔ∏è Nubosidad</span>
                                <span>${Math.round(day.avgClouds)}%</span>
                            </div>
                            <div class="day-detail-row">
                                <span class="day-detail-label">‚òÄÔ∏è UV m√°x</span>
                                <span>${Math.round(day.maxUV)}</span>
                            </div>
                            ${dayTides.map(t => `
                                <div class="day-detail-row">
                                    <span class="day-detail-label">${t.type === 'high' ? 'üî∫ Pleamar' : 'üîª Bajamar'}</span>
                                    <span>${formatTime(t.time)}</span>
                                </div>
                            `).join('')}

                            <div style="margin-top: 12px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">Temperatura por hora:</div>
                                <div class="hourly-scroll">
                                    ${day.hours.filter(h => h.hour >= 9 && h.hour <= 19).map(h => `
                                        <div class="hour-item">
                                            <div class="time">${h.hour}h</div>
                                            <div class="value">${Math.round(h.temp)}¬∞</div>
                                            <div class="extra">${Math.round(h.rainProb)}%üåßÔ∏è</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =====================================================
        // RENDER PRINCIPAL
        // =====================================================

        function render() {
            const content = document.getElementById('content');

            if (!weatherData) {
                content.innerHTML = '<div class="error-card">No se pudieron cargar los datos. Intent√° actualizar.</div>';
                return;
            }

            const weatherDays = processWeatherByDay(weatherData);
            const marineDays = marineData ? processMarineByDay(marineData) : [];

            const now = new Date();
            const estimatedTides = estimateTides(now, 7);
            const allTides = processTides(tidesData, estimatedTides);
            const tidesAreEstimated = !tidesData || allTides[0]?.estimated;

            let html = '';

            if (currentTab === 'playa') {
                html = renderPlaya(weatherDays, allTides, tidesAreEstimated);
            } else {
                html = renderSurf(weatherDays, marineDays, allTides);
            }

            content.innerHTML = html;
        }

        // =====================================================
        // API KEY & LOAD
        // =====================================================

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (input && input.value.trim()) {
                WORLDTIDES_KEY = input.value.trim();
                localStorage.setItem('worldtides_key', WORLDTIDES_KEY);
                loadAllData();
            }
        }

        async function loadAllData() {
            const btn = document.getElementById('refreshBtn');
            const content = document.getElementById('content');

            btn.disabled = true;
            btn.textContent = '‚è≥ Cargando...';

            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando condiciones...</p>
                </div>
            `;

            try {
                const [weather, marine, tides] = await Promise.all([
                    fetchWeather(),
                    fetchMarine(),
                    fetchTides()
                ]);

                weatherData = weather;
                marineData = marine;
                tidesData = tides;

                render();

                document.getElementById('lastUpdate').textContent =
                    `Actualizado: ${formatTime(new Date())}`;

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `
                    <div class="error-card">
                        <p>‚ùå Error al cargar</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Actualizar';
            }
        }

        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
